# MDebook

VIMキーバインド、多言語対応、EPUB/PDF/HTML/Markdownエクスポート機能を備えたブラウザベースのMarkdown電子書籍エディタ。

**バージョン: 0.8.1**

**[🇬🇧 English version](README.md)**

## ✨ 機能

### エディタ
- **VIMキーバインド** - `:w`, `:q`, `:e` コマンド対応のフルVIMモード
- **CodeMirror 6** - シンタックスハイライト付きモダンエディタ
- **ライブプレビュー** - 双方向スクロール同期のリアルタイムMarkdownプレビュー
- **マルチファイル対応** - ドラッグ&ドロップで並び替え可能な複数チャプター管理

### インポート & エクスポート
- **エクスポート形式**: EPUB, PDF (pdfmake), HTML, Markdown (ZIP)
- **インポート**: ローカルファイル、URL（Qiita、GitHub自動変換）
- **プロジェクト形式**: `.mdebook`（ZIPベース）で画像付きプロジェクトを保存/読み込み

### PDFエクスポート（v0.8.1新機能）
- **日本語フォント対応** - カスタムTTF/OTFフォントをアップロード（IndexedDBに保存）
- **目次** - 内部リンク付き自動生成
- **ページ番号** - ヘッダーにタイトル、フッターにページ番号
- **テーマCSS対応** - EPUBテーマの行間、文字間隔を反映
- **テーブル、リンク、書式** - フルMarkdown対応
- **章扉** - 目次で結合表示（例：「第1章 はじめに」）
- **奥付** - 特別なフォーマット、目次から除外
- **絵文字処理** - PDFでは自動削除（EPUB/HTMLでは保持）

### EPUBテーマ
- **5つのプリセットテーマ**: クラシック、モダン、テクニカル、小説、アカデミック
- **カスタムCSSインポート**: 独自のCSSでEPUBスタイリング
- **CSSエクスポート**: テーマCSSをカスタマイズ用にエクスポート
- **Kindle最適化**: すべてのテーマがKindleパブリッシングガイドライン2025に準拠

### 書籍構成テンプレート
- **奥付**: EPUB末尾に自動配置、出版情報テンプレート
- **はじめに**: EPUB先頭に自動配置
- **章扉**: エピグラフ付きの装飾的な章開始ページ
- **参考文献**: 引用形式テンプレート

### 補足欄（アドモニション）
```markdown
:::note
これは注釈です。
:::

:::warning 警告タイトル
これは警告メッセージです。
:::
```
対応タイプ: `note`, `warning`, `tip`, `info`, `caution`, `important`

### Markdown機能
- テーブル（GFM）
- シンタックスハイライト付きコードブロック
- Mermaidダイアグラム（EPUB用PNG変換）
- 脚注
- 画像埋め込み（ペースト、ドラッグ&ドロップ、ファイル選択）
- **画像/Mermaidサイズ指定**: `{width=50% align=center}` 属性構文

### ユーザーエクスペリエンス
- **5言語対応**: English, 日本語, 简体中文, Español, 한국어
- **ダーク/ライトテーマ**
- **自動保存** - IndexedDBセッション管理
- **キーボードショートカット**: `Ctrl+\`` でVIM切替

## 🚀 クイックスタート

### オンラインデモ

ブラウザで今すぐMDebookを試す：

**👉 [MDebook を起動](https://fukuyori.github.io/mdebook/dist/mdebook.html)**

インストール不要 - 開いてすぐに書き始められます！

### ソースからビルド

```bash
# リポジトリをクローン
git clone https://github.com/fukuyori/mdebook.git
cd mdebook

# 依存関係をインストール
npm install

# 開発サーバー
npm run dev

# プロダクションビルド
npm run build

# スタンドアロンHTMLを生成
node build-html.cjs
```

## 📖 ドキュメント

- [Tutorial (English)](docs/tutorial.md)
- [チュートリアル (日本語)](docs/tutorial.ja.md)

## 📄 PDFエクスポート

### 日本語フォントの設定

1. [Google Fonts - Noto Sans JP](https://fonts.google.com/noto/specimen/Noto+Sans+JP) からフォントをダウンロード
2. 設定（歯車アイコン）を開く
3. 「PDF用フォント設定」までスクロール
4. 標準フォント（必須）と太字フォント（任意）をアップロード
5. フォントはIndexedDBに保存（セッション間で永続化）

### PDF機能

| 機能 | 対応 |
|------|------|
| 見出し（h1-h4） | ✅ 目次リンク付きスタイル |
| テーブル | ✅ 罫線とヘッダースタイル |
| コードブロック | ✅ 等幅フォント、背景色 |
| リスト（ul/ol） | ✅ ネスト対応 |
| リンク | ✅ クリック可能、下線付き |
| 太字/イタリック | ✅ インライン書式 |
| 引用 | ✅ インデント付きスタイル |
| 水平線 | ✅ グレーライン |
| 章扉 | ✅ 結合目次エントリ |
| 奥付 | ✅ 目次から除外 |
| 絵文字 | ⚠️ 自動削除（フォント制限） |
| 画像 | ❌ 未対応 |
| Mermaid | ❌ 未対応 |

### 目次深度設定

目次深度設定はEPUBとPDF両方に影響：
- **0**: 目次なし
- **1**: H1のみ
- **2**: H1 + H2（デフォルト）
- **3**: H1 + H2 + H3

## 🎨 EPUBテーマ

### プリセットテーマ

| テーマ | 説明 | 用途 |
|--------|------|------|
| **クラシック** | 伝統的なセリフ体デザイン | 文学、一般書籍 |
| **モダン** | 青いアクセントのサンセリフ体 | ビジネス書 |
| **テクニカル** | ダークレッド見出しのオライリー風 | 技術ドキュメント |
| **小説** | シーン区切り対応の読書最適化 | フィクション |
| **アカデミック** | 両端揃えの学術スタイル | 学術論文 |

### Kindle最適化CSS

すべてのテーマはKindleデバイス向けに最適化：

```css
/* 基本設定 */
html { font-size: 100%; }
body {
  margin: 0;
  padding: 0;
  line-height: 1.7;           /* 読みやすい行間 */
  text-align: justify;         /* 電子書籍標準の両端揃え */
  word-wrap: break-word;       /* 長い英単語の突き抜け防止 */
}

/* 見出し */
h1 { font-size: 1.6em; page-break-before: always; }
h2 { font-size: 1.3em; }
h3 { font-size: 1.1em; }

/* コード - font-size累積防止のため分離定義 */
code { font-size: 0.9em; }
pre { font-size: 0.9em; }
pre code { font-size: inherit; }  /* ネストされたcodeをリセット */
```

### カスタムCSS

1. **↓ CSS** をクリックしてテーマを開始点としてエクスポート
2. CSSファイルを編集してスタイルをカスタマイズ
3. **↑ CSS** をクリックしてカスタムCSSをインポート
4. テーマが自動的に「カスタム」に切り替わる

## 📑 書籍構成

### テンプレートメニュー

「テンプレート追加」をクリックして定型テンプレートを挿入：

| テンプレート | ファイル名 | 配置位置 |
|------------|-----------|---------|
| 📋 奥付 | `奥付.md` / `colophon.md` | 末尾（自動） |
| 📖 はじめに | `はじめに.md` / `preface.md` | 先頭（自動） |
| 📑 章扉 | `章扉N.md` | 現在のタブの次 |
| 📚 参考文献 | `参考文献.md` / `bibliography.md` | 奥付の前（自動） |

### 章扉ページ

章扉ページは自動検出されてフォーマットされます：
- 目次: 「第1章 章タイトル」形式で結合
- PDF: 中央揃えのタイトル、オプションのエピグラフ

検出パターン:
- `<div class="chapter-title-page">` ラッパー
- または `# 第N章` に続く `## サブタイトル`

### EPUBファイル順序
EPUBエクスポート時にファイルは自動的にソートされます：
1. はじめに/序文
2. 通常の章（元の順序）
3. 参考文献
4. 奥付

## 🎮 VIMコマンド

| コマンド | 説明 |
|----------|------|
| `i`, `a`, `o` | INSERTモードに入る |
| `Esc` | NORMALモードに戻る |
| `v`, `V` | VISUALモード |
| `hjkl` | カーソル移動 |
| `y`, `yy` | ヤンク（コピー） |
| `d`, `dd` | 削除（カット） |
| `p`, `P` | ペースト |
| `"*y` | システムクリップボードへコピー |
| `"*p` | システムクリップボードからペースト |
| `"+y` | システムクリップボードへコピー（別名） |
| `"+p` | システムクリップボードからペースト（別名） |
| `:w` | 保存（ファイルハンドルがあれば上書き） |
| `:w!` | ダイアログで保存 |
| `:w filename` | 名前を付けて保存 |
| `:e filename` | ファイルを開く/作成 |
| `:q` | 現在のファイルを閉じる |
| `:wq` | 保存して閉じる |
| `:imp` | インポートダイアログを開く |
| `:imp URL` | URLからインポート |

## 📁 プロジェクト構造

```
mdebook/
├── src/
│   ├── components/     # Reactコンポーネント
│   ├── utils/          # ユーティリティ関数
│   │   ├── export.ts   # EPUB/HTMLエクスポート
│   │   ├── pdf-export.ts # PDFエクスポート（pdfmake）
│   │   └── storage.ts  # IndexedDB操作
│   ├── i18n/           # 翻訳
│   ├── types/          # TypeScript型定義
│   ├── hooks/          # Reactフック
│   ├── themes/         # EPUBテーマ定義
│   └── constants/      # 定数
├── dist/               # ビルド出力
└── docs/               # ドキュメント
```

## 🔧 技術スタック

- **フロントエンド**: React 18, TypeScript
- **エディタ**: CodeMirror 6 + @replit/codemirror-vim
- **スタイリング**: Tailwind CSS
- **ビルド**: Vite
- **エクスポート**: JSZip, FileSaver.js, Mermaid, pdfmake

## 📦 エクスポート形式

### EPUB
ほとんどの電子書籍リーダーと互換性のある標準的な電子書籍形式。表紙画像、カスタムテーマ、Mermaidダイアグラム変換をサポート。

### PDF
pdfmakeによるネイティブPDF生成。日本語フォント、テーブル、コードブロック、自動生成目次をサポート。

### HTML
スタイルを埋め込んだスタンドアロンHTMLファイル。

### Markdown (ZIP)
```
book-markdown.zip
├── metadata.json
├── chapters/
│   ├── chapter1.md
│   └── chapter2.md
└── images/
    └── image1.png
```

### .mdebookプロジェクト形式
```
project.mdebook (ZIP)
├── manifest.json
├── chapters/
│   ├── chapter1.md      # .md拡張子付き
│   └── chapter2.md
└── images/
    └── cover.png
```

📄 **[ファイル形式仕様](docs/FILE_FORMAT.ja.md)** - 詳細な技術ドキュメント

## 🌐 ブラウザ互換性

| ブラウザ | サポート |
|----------|----------|
| Chrome/Edge | ✅ フルサポート（File System Access API） |
| Firefox | ✅ サポート（フォールバックファイル処理） |
| Safari | ✅ サポート（フォールバックファイル処理） |

**注意**: IndexedDB（フォント保存用）は一部のブラウザで`file://`プロトコルでは制限される場合があります。最良の結果を得るにはローカルサーバーまたはChromeを使用してください。

## 📝 変更履歴

### v0.5.5
- **画像・Mermaidサイズ指定**:
  - 画像に属性構文でサイズ指定: `![alt](image.png){width=50%}`
  - Mermaidダイアグラムにサイズ指定: `` ```mermaid {width=70% align=center} ``
  - 対応属性: `width`, `height`, `max-width`, `max-height`, `align`
  - プレビュー、EPUB、HTMLエクスポートで反映
- **文字エンコーディング自動検出**:
  - Shift_JIS、EUC-JP、ISO-2022-JP（JIS）ファイルを自動判定
  - UTF-8以外のテキストファイルも文字化けなしで読み込み可能
  - 改行コードをLFに正規化
- **VIMシステムクリップボード対応**:
  - `"*y` / `"*yy` - システムクリップボードにコピー
  - `"*p` / `"*P` - システムクリップボードから貼り付け
  - `"+`レジスタも同様に対応

### v0.5.2
- **ルビ（ふりがな）対応**:
  - 青空文庫形式: `｜漢字《かんじ》` または `漢字《かんじ》`
  - プレビュー: HTMLのrubyタグで表示
  - EPUB: `<ruby>`タグで完全対応
  - PDF: 括弧形式にフォールバック `漢字(かんじ)`
- **VIMマーク永続化**:
  - ローカルマーク（a-z）がファイル切り替え時に保持されるように
  - `ma`でマーク設定、`` `a ``または`'a`でジャンプ
  - `:marks`で現在のファイルのマーク一覧表示
- **UI改善**:
  - ファイルタブにフォーカスがあっても`:`キーでVIMコマンドモードに入れるように
  - 新規ファイルが空で作成されるように変更（プレースホルダーテキストなし）

### v0.5.1
- **VIMモードIME対応強化**:
  - `f`/`F`/`t`/`T` 文字検索コマンドでIME入力をサポート
  - `r` 1文字置換でIME入力をサポート
  - `/`や`?`検索コマンドでIME入力をサポート
  - `:s/パターン/置換/` 置換コマンドでIME入力をサポート
  - ノーマル/ビジュアルモードではIME入力をブロック（誤入力防止）
- **VIMモードページスクロール修正**:
  - `Ctrl+f`/`Ctrl+b`で画面スクロール時にカーソルの相対位置を維持
  - 2行のオーバーラップを持つVIM本来の動作に修正

### v0.5.0
- **VIM :eコマンド強化**:
  - `:e filename` - プロジェクトをクリアし、指定した名前で新規ファイルを作成
  - `:e! filename` - `:e`と同じ（強制作成）
  - `:e`（引数なし）- ファイルを開くダイアログ（従来の動作）
- **mdvim形式サポート**:
  - `.mdvim`ファイルのインポート（ドラッグ&ドロップ、ファイル選択、または開くダイアログ）
  - ZIPアーカイブ形式とプレーンテキストMarkdown形式の両方をサポート
  - 現在のファイルを`.mdvim`形式でエクスポート
  - 画像の自動抽出と埋め込み
  - メタデータの保持（タイトル、著者、言語）
  - 重複ファイル名・画像名の処理（"filename (1)"のようなサフィックスを追加）

### v0.4.6
- **ドキュメント**:
  - ファイル形式仕様書を追加（FILE_FORMAT.ja.md）

### v0.4.5
- **VIMモード安定性修正**:
  - テーマ/フォントサイズ変更時のエディタ再作成によるINSERTモードの入力問題を修正
  - Compartmentベースの動的再構成を実装（テーマとフォントサイズ）
  - テーマ切り替え時にVIM状態（モード、コマンドバッファ）が保持されるように
  - VIMリスナー設定のリトライロジックを改善
- **PDFエクスポート強化**:
  - 引用（blockquote）が改行を保持（各`>`行が別々の行に）
  - 章扉のエピグラフが適切な改行で表示

### v0.4.4
- **PDFエクスポート強化**:
  - 日本語フォント対応のpdfmake完全統合
  - カスタムTTF/OTFフォントのアップロード（IndexedDB保存）
  - 罫線とヘッダースタイル付きテーブル対応
  - リンク、イタリック、水平線対応
  - 背景色と等幅フォント付きコードブロック
  - テーマCSS反映（行間、文字間隔、テキスト配置）
  - 絵文字自動削除（フォントは絵文字非対応のため）
  - 章扉: 結合目次エントリ（例：「第1章 章タイトル」）
  - 奥付: 特別フォーマット、目次から除外
- **EPUBエクスポート強化**:
  - 章扉: 結合目次エントリ
  - コードブロック内の見出しを目次から除外
- **プロジェクト形式**:
  - `.mdebook`内のMarkdownファイルに`.md`拡張子を付与
  - タブ表示は拡張子なし

### v0.4.3
- **Kindle最適化CSS**: 全5テーマをKindleパブリッシングガイドライン2025に準拠して書き直し
  - `html { font-size: 100%; }` でユーザーのフォント設定を尊重
  - `body { line-height: 1.7; text-align: justify; word-wrap: break-word; }`
  - 見出し: h1=1.6em, h2=1.3em, h3=1.1em、h1に`page-break-before: always`
  - コードブロック: `<pre><code>`ネストでのfont-size累積防止のため分離定義
- **特定フォントファミリーの削除**: 電子書籍リーダー互換性のため総称ファミリーのみ使用

### v0.4.2
- 章扉を現在のタブの次に挿入するように変更
- 章扉の目次表示を改善
- 全テーマからbodyのfont-sizeを削除

### v0.4.1
- 書籍構成テンプレート: 奥付、はじめに、章扉、参考文献
- 補足欄ブロック（:::note, :::warning, :::tip 等）
- EPUB自動ファイル順序
- 表紙画像の永続化修正
- EPUB互換のMermaid PNG変換

### v0.4.0
- 5つのEPUBプリセットテーマを追加
- EPUB用カスタムCSSインポート/エクスポート
- Kindleパブリッシングガイドライン準拠
- 階層的目次

### v0.3.x
- EPUB表紙画像サポート
- .mdebookプロジェクト形式
- 画像管理
- URL/Qiitaインポート

## 📄 ライセンス

MIT License

## 🤝 コントリビューション

コントリビューションを歓迎します！お気軽にプルリクエストを送ってください。

## 🙏 謝辞

- [CodeMirror](https://codemirror.net/)
- [@replit/codemirror-vim](https://github.com/replit/codemirror-vim)
- [Marked](https://marked.js.org/)
- [Mermaid](https://mermaid.js.org/)
- [JSZip](https://stuk.github.io/jszip/)
- [pdfmake](http://pdfmake.org/)
